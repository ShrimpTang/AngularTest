<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <style>

        #productTypeDiv ul {
            list-style: none;
            padding: 0px;
            background: url("ul-bg.gif") repeat-y 5px 0px;
        }

        #productTypeDiv li {
            padding: 5px 0 2px 15px;
            background: url("tree-ul-li.gif") no-repeat 5px -32px;
        }

        #productTypeDiv li a {
            font-size: 12px;
            cursor: pointer;

        }

        #productTypeDiv ul li em {
            cursor: pointer;
            display: inline-block;
            width: 15px;
            float: left;
            height: 15px;
            margin-left: -14px;
            background: url("tree-ul-li.gif") no-repeat -32px 2px;
        }

        #productTypeDiv ul li em.off {
            background-position: -17px -18px;
        }

        .end {
            background-color: white;
        }
    </style>
</head>
<body>
<input id="searchProductType">
<button id="searchProductTypeBtn">定位</button>
<div id="productTypeDiv">

</div>
<input type="button" id="editProductType" value="编辑分类">
</body>
<script src="jquery-1.6.2.min.js"></script>
<script>
    var productTypeOp = {
        add: function (id, pid) {
            console.info('ccc');
        },
        del: function (id) {

        }
    }
    $(function () {

        //data = $.parseJSON(data);
        var html = createContent('-1', data);
        $("#productTypeDiv").append(html);
        $("#editProductType").data('isEdit', false);
        $("#productTypeDiv li").each(function () {
            if ($("#" + this.id + " ~ li").length == 0) {
                $(this).css("background-color", "white");
            }
            if ($(this).find('li').length == 0) {
                $(this).find('em').remove();
            }
        });
        $("#productTypeDiv em").each(function () {
            $(this).click(function () {
                if ($(this).hasClass('off')) {
                    $(this).removeClass('off');
                    $(this).siblings('ul').hide();
                } else {
                    $(this).addClass('off');
                    $(this).siblings('ul').show();
                }
            });
        });

        $("#editProductType").click(function () {
            if ($("#editProductType").data('isEdit')) {//是编辑的时候点击就保存
                hideVisibleBtn();
                // TODO ajax重新加载
                $("#editProductType").data('isEdit', false);
                $("#editProductType").val('编辑分类');

            } else {//不是编辑的时候点击变成编辑状态
                $("#editProductType").data('isEdit', true);
                $("#editProductType").val('编辑完成');
            }
        });


        var sptbClickCount = 0;
        $('#searchProductType').keyup(function (e) {
            if (e.keyCode == 13) {
                $("#searchProductTypeBtn").click();
            }
        });
        $("#searchProductTypeBtn").click(function () {
            var sval = $.trim($("#searchProductType").val());
            if (sval == '')return;
            var oldValue = $('#searchProductType').data('oldValue');
            if (sval == oldValue) {
                sptbClickCount++;
            } else {
                sptbClickCount = 1;
                $('#searchProductType').data('oldValue', sval);
            }

            var eqindex = 0;
            var eqlength = $('#productTypeDiv a[data="' + sval + '"]').length;
            $("#productTypeDiv a").each(function () {
                if ($(this).text() == sval) {
                    eqindex++;
                    if (sptbClickCount % eqlength == eqindex % eqlength) {
                        $(this).click();
                        var pids = $(this).attr('parentids').split(',');

                        for (var i = 0; i < pids.length; i++) {
                            if (pids[i] != '') {
                                $("#li_" + pids[i]).parent().show();
                                $("#li_" + pids[i] + " > em").addClass('off');

                            }
                        }
                        $(this).parent().parent().show();
                    }
                }
            });
        });
        function hideVisibleBtn() {
            $("#productTypeDiv input[id^='addbtn_']:visible").hide();
            $("#productTypeDiv input[id^='delbtn_']:visible").hide();
        }

        function createContent(parentids, json) {
            var ht = $('<ul>');
            if (parentids.split(",").length > 1) {
                // ht.hide();
            }
            for (var i = 0; i < json.length; i++) {
                var obj = json[i];
                if (obj.parentids == parentids) {
                    var li = $('<li id="li_' + obj.ID + '"></li>');
                    var name = $('<a data="' + obj.name + '" parentids="' + obj.parentids + '" id="a_' + obj.ID + '">' + obj.name + '</a>');

                    var em = $('<em id="em_' + obj.ID + '" class="off"></em>');
                    var newName = $('<input  type="text" id="newname_' + obj.ID + '" name="cptList[' + i + '].name" value="' + obj.name + '" >').hide();
                    var oldName = $('<input type="hidden" name="cptList[' + i + '].oldName" value="' + obj.name + '" >');
                    var $id = $('<input type="hidden" name="cptList[' + i + '].id" value="' + obj.ID + '" >');
                    var $parentids = $('<input type="hidden" style="width:100px" name="cptList[' + i + '].parentids" value="' + obj.parentids + '" >');
                    var $addBtn = $('<input type="button" style="display:none" value="添加" id="addbtn_' + obj.ID + '" onclick="productTypeOp.add(\'' + obj.ID + '\',\'' + obj.parentids + '\')">');
                    var $delBtn = $('<input type="button" style="display:none" value="删除" id="delbtn_' + obj.ID + '" onclick="productTypeOp.del(\'' + obj.ID + '\')">');
                    if (obj.order == 1 || obj.order == 0) {
                        $delBtn.attr('disabled', 'disabled');
                    }
                    name.click(function () {
                        if ($("#editProductType").data('isEdit')) {
                            var id = this.id.split("_")[1];
                            hideVisibleBtn();
                            $("#newname_" + id + ",#addbtn_" + id + ",#delbtn_" + id).show();
                            $("#newname_" + id).focus();
                            $(this).hide();
                        } else {
                            $("#productTypeDiv a").css('background-color', 'white');
                            $(this).css('background-color', '#ADD6ED');

                        }
                    });
                    newName.blur(function () {
                        var id = this.id.split("_")[1];
                        $("#a_" + id).text($(this).val()).show();
                        $(this).hide();
                    });
                    li.append(em).append(name).append(oldName).append($id).append($parentids).append(newName).append($addBtn).append($delBtn);
                    ht.append(li);
                    if (obj.parentids == -1) {
                        li.append(createContent(obj.ID, json));
                    } else {
                        li.append(createContent(obj.parentids + "," + obj.ID, json));
                    }
                }
            }
            return ht;
        }
    });


    var data = [{
        ID: '0',
        name: '全部产品',
        parentids: '-1',
        order: '0'
    }, {
        ID: '1',
        name: '未分类',
        parentids: '0',
        order: '1'
    }, {
        ID: '2',
        name: '秤',
        parentids: '0',
        order: '2012'
    }, {
        ID: '16',
        name: '手提秤',
        parentids: '0,2',
        order: '2013'
    }, {
        ID: '3',
        name: '未分类',
        parentids: '0,2',
        order: '2014'
    }, {
        ID: '4',
        name: '体重秤',
        parentids: '0,2',
        order: '2014'
    }, {
        ID: '5',
        name: '衣服',
        parentids: '0',
        order: '2015'
    }, {
        ID: '6',
        name: '上衣',
        parentids: '0,5',
        order: '2016'
    }, {
        ID: '7',
        name: '针织衫',
        parentids: '0,5,6',
        order: '2017'
    }, {
        ID: '8',
        name: 'T血',
        parentids: '0,5,6',
        order: '2018'
    }, {
        ID: '9',
        name: '内衣',
        parentids: '0,5,6',
        order: '2019'
    }, {
        ID: '10',
        name: '未分类',
        parentids: '0,5,6,9',
        order: '2020'
    }, {
        ID: '11',
        name: '背心',
        parentids: '0,5,6,9rrrrrrrrrrrrrrrrrrr',
        order: '2021'
    }, {
        ID: '12',
        name: '裤子',
        parentids: '0,5',
        order: '2020'
    }, {
        ID: '13',
        name: '鞋子',
        parentids: '0,5',
        order: '2021'
    }, {
        ID: '14',
        name: '软件',
        parentids: '0',
        order: '2022'
    }];
    /*
     $(function() {
     $.post(contextPath + "/product_ajaxGetProductTypeJsonList.yk",function(data){
     data = $.parseJSON(data);
     var html = createContent('-1', data);
     $("#productTypeDiv").append(html);
     });
     function createContent(parentids, json) {
     var ht = $('
     <ul>');
     if (parentids.split(",").length>1) {
     ht.hide();
     }
     for (var i = 0; i < json.length; i++) {
     var obj = json[i];
     if (obj.parentids == parentids) {
     var li = $('
     <li>'+obj.name+'</li>
     ')
     ht.append(li);
     if (obj.parentids == -1) {
     li.append( createContent(obj.ID, json));
     } else {
     li.append(createContent(obj.parentids + "," + obj.ID, json));
     }
     }
     }
     return ht;
     }
     });
     */

    $(function () {

//        var hrtml = createContent('-1', json);
//        $("#content").html(hrtml);
//        function createContent(parentids, json) {
//            var ht = '<ul>';
//            for (var i = 0; i < json.length; i++) {
//                var obj = json[i];
//                if (obj.parentids == parentids) {
//                    ht += '<li>' + obj.name;
//                    if (obj.parentids == -1) {
//                        ht += createContent(obj.id, json);
//                    } else {
//                        ht += createContent(obj.parentids + "," + obj.id, json);
//                    }
//                    ht += '</li>';
//                }
//            }
//
//            ht += '</ul>';
//            return ht;
//
//        }
    });

</script>
</html>


